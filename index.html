<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pediatric CMR Reference Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .input-group {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .input-field {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: flex-start;
        }
        .input-field label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .input-field input, .input-field select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 120px;
        }
        .unit-toggle {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .unit-toggle button {
            padding: 5px 10px;
            background-color: #e9ecef;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .unit-toggle button.active {
            background-color: #007bff;
            color: white;
        }
        .atrial-row, .ventricular-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        .atrial-column, .ventricular-column {
            flex: 1;
        }
        .ventricular-row {
            display: flex;
            gap: 20px;
        }
        .ventricular-column {
            flex: 1;
        }
        button.calculate {
            padding: 12px 24px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
        }
        button.calculate:hover {
            background-color: #218838;
        }
        button.calculate:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .results-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #e9f7ef;
            display: none;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th, .results-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .results-table th {
            background-color: #f2f2f2;
        }
        .loading {
            color: #007bff;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
            text-align: center;
            padding: 20px;
        }
        .info {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        /* Print button styles */
        #printButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        #printButton:hover {
            background-color: #0056b3;
        }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            #printArea, #printArea * {
                visibility: visible;
            }
            
            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .print-header {
                margin-bottom: 20px;
            }
            
            .print-header input {
                border: none;
                border-bottom: 1px solid #000;
                margin: 5px 0;
                padding: 5px;
            }
            
            .print-patient-info {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
            }

            .print-footer {
                margin-top: 20px;
                font-size: 12px;
                text-align: center;
                border-top: 1px solid #ccc;
                padding-top: 10px;
            }
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pediatric CMR Reference Calculator</h1>
        
        <div class="section">
            <h2>Patient Information</h2>
            <div class="input-group">
                <div class="input-field tooltip">
                    <label for="age">Age (years)</label>
                    <input type="number" id="age" step="0.1" min="0" max="18" placeholder="e.g., 7.5">
                    <span class="tooltip-text">Enter age between 0-18 years. For infants less than 1 year, enter 0.</span>
                </div>
                <div class="input-field">
                    <label for="gender">Gender</label>
                    <select id="gender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="input-field">
                    <label for="height">Height</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="height" step="0.1" min="0" placeholder="e.g., 120">
                        <div class="unit-toggle">
                            <button id="cm-toggle" class="unit-btn active" data-unit="cm">cm</button>
                            <button id="in-toggle" class="unit-btn" data-unit="in">in</button>
                        </div>
                    </div>
                </div>
                <div class="input-field">
                    <label for="weight">Weight</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="weight" step="0.1" min="0" placeholder="e.g., 25">
                        <div class="unit-toggle">
                            <button id="kg-toggle" class="unit-btn active" data-unit="kg">kg</button>
                            <button id="lb-toggle" class="unit-btn" data-unit="lb">lb</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Atrial Measurements (ml)</h2>
            <div class="atrial-row">
                <div class="atrial-column">
                    <div class="input-group">
                        <div class="input-field">
                            <label for="lav">LAV</label>
                            <input type="number" id="lav" step="0.1" min="0" placeholder="e.g., 25">
                        </div>
                    </div>
                </div>
                <div class="atrial-column">
                    <div class="input-group">
                        <div class="input-field">
                            <label for="rav">RAV</label>
                            <input type="number" id="rav" step="0.1" min="0" placeholder="e.g., 20">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Ventricular Measurements (ml)</h2>
            <div class="ventricular-row">
                <div class="ventricular-column">
                    <h3>Left Ventricle</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="lvedv">LVEDV</label>
                            <input type="number" id="lvedv" step="0.1" min="0" placeholder="e.g., 60">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="lvesv">LVESV</label>
                            <input type="number" id="lvesv" step="0.1" min="0" placeholder="e.g., 20">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="lvsv">LVSV</label>
                            <input type="number" id="lvsv" step="0.1" min="0" placeholder="e.g., 40">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="lvm">LVM</label>
                            <input type="number" id="lvm" step="0.1" min="0" placeholder="e.g., 60">
                        </div>
                    </div>
                </div>
                <div class="ventricular-column">
                    <h3>Right Ventricle</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="rvedv">RVEDV</label>
                            <input type="number" id="rvedv" step="0.1" min="0" placeholder="e.g., 65">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="rvesv">RVESV</label>
                            <input type="number" id="rvesv" step="0.1" min="0" placeholder="e.g., 25">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="rvsv">RVSV</label>
                            <input type="number" id="rvsv" step="0.1" min="0" placeholder="e.g., 40">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="rvm">RVM</label>
                            <input type="number" id="rvm" step="0.1" min="0" placeholder="e.g., 55">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button id="calculateBtn" class="calculate">Calculate Z-scores</button>

        <div class="results-section" id="resultsSection">
            <h2>Results</h2>
            <div id="resultsContent"></div>
        </div>

        <div class="info">
            <p><strong>Note:</strong> This application fetches data from the 
                <a href="https://miracleapi.readme.io/" target="_blank">MIRACLE API</a>. 
                View the <a href="https://github.com/drankush/MIRACLE-API" target="_blank">GitHub repository</a>. 
                Ensure all inputs are correct for accurate results.
            </p>
        </div>

        <button id="printButton" onclick="printResults()">Print</button>
    </div>

    <script>
        // API URLs
        const ATRIAL_API_URL = 'https://script.google.com/macros/s/AKfycbz4Nq-1EzijdLynEEm5laie5UqUO25-Wdyti8_tHXzm9uAKE8PcTgI6mQgvvxYBlogu/exec';
        const VENTRICULAR_API_URL = 'https://script.google.com/macros/s/AKfycbwa0oPunWWhNhvdQZXDj3Sd01f_onFN2DHOg-LpEfMVqQWuFxZov0ZgRhK9Oia94k7c/exec';

        // DOM Elements
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');
        
        // Unit toggle buttons
        const cmToggle = document.getElementById('cm-toggle');
        const inToggle = document.getElementById('in-toggle');
        const kgToggle = document.getElementById('kg-toggle');
        const lbToggle = document.getElementById('lb-toggle');
        
        // Height unit state
        let heightUnit = 'cm';
        let weightUnit = 'kg';

        // Event Listeners
        cmToggle.addEventListener('click', () => setHeightUnit('cm'));
        inToggle.addEventListener('click', () => setHeightUnit('in'));
        kgToggle.addEventListener('click', () => setWeightUnit('kg'));
        lbToggle.addEventListener('click', () => setWeightUnit('lb'));
        calculateBtn.addEventListener('click', calculateZScores);

        // Set height unit
        function setHeightUnit(unit) {
            heightUnit = unit;
            cmToggle.classList.toggle('active', unit === 'cm');
            inToggle.classList.toggle('active', unit === 'in');
        }

        // Set weight unit
        function setWeightUnit(unit) {
            weightUnit = unit;
            kgToggle.classList.toggle('active', unit === 'kg');
            lbToggle.classList.toggle('active', unit === 'lb');
        }

        // Convert units to metric
        function convertToMetric() {
            const heightValue = parseFloat(document.getElementById('height').value);
            const weightValue = parseFloat(document.getElementById('weight').value);
            
            if (isNaN(heightValue) || isNaN(weightValue)) {
                throw new Error('Please enter valid height and weight values');
            }
            
            let ht_cm, wt_kg;
            
            if (heightUnit === 'in') {
                ht_cm = heightValue * 2.54;
            } else {
                ht_cm = heightValue;
            }
            
            if (weightUnit === 'lb') {
                wt_kg = weightValue * 0.453592;
            } else {
                wt_kg = weightValue;
            }
            
            return { ht_cm, wt_kg };
        }

        // Calculate BSA using Haycock formula
        function calculateBSA(ht_cm, wt_kg) {
            return 0.024265 * Math.pow(wt_kg, 0.5378) * Math.pow(ht_cm, 0.3964);
        }

        // Calculate Z-scores
        async function calculateZScores() {
            // Disable button during calculation
            calculateBtn.disabled = true;
            resultsSection.style.display = 'none';
            resultsContent.innerHTML = '<div class="loading">Calculating...</div>';
            resultsSection.style.display = 'block';

            try {
                // Get patient information
                const age = parseFloat(document.getElementById('age').value);
                const gender = document.getElementById('gender').value;
                
                if (isNaN(age)) {
                    throw new Error('Please enter a valid age');
                }
                
                if (age > 18) {
                    throw new Error('Age must be between 0-18 years');
                }

                // Convert units to metric
                const { ht_cm, wt_kg } = convertToMetric();
                
                // Prepare results array
                const results = [];
                
                // Calculate atrial measurements
                const lav = parseFloat(document.getElementById('lav').value);
                const rav = parseFloat(document.getElementById('rav').value);
                
                if (!isNaN(lav)) {
                    try {
                        const response = await fetch(`${ATRIAL_API_URL}?domain=pediatric_atrial&parameter=LAVi&gender=${gender}&age=${age}&av=${lav}&ht_cm=${ht_cm}&wt_kg=${wt_kg}`);
                        const data = await response.json();
                        
                        if (data.results) {
                            results.push({
                                parameter: 'LAVi',
                                measured: data.input.LAVi ? parseFloat(data.input.LAVi).toFixed(2) : 'N/A',
                                zScore: data.results.calculated_sds ? parseFloat(data.results.calculated_sds).toFixed(2) : 'N/A',
                                centile: data.results.calculated_percentile ? parseFloat(data.results.calculated_percentile).toFixed(1) : 'N/A',
                                reference: data.reference_data ? 
                                    `P3: ${data.reference_data.P3_ml_per_m2} ml/m2; P50: ${data.reference_data.P50_ml_per_m2} ml/m2; P97: ${data.reference_data.P97_ml_per_m2} ml/m2` : 
                                    'N/A'
                            });
                        }
                    } catch (error) {
                        console.error('Error calculating LAVi:', error);
                    }
                }
                
                if (!isNaN(rav)) {
                    try {
                        const response = await fetch(`${ATRIAL_API_URL}?domain=pediatric_atrial&parameter=RAVi&gender=${gender}&age=${age}&av=${rav}&ht_cm=${ht_cm}&wt_kg=${wt_kg}`);
                        const data = await response.json();
                        
                        if (data.results) {
                            results.push({
                                parameter: 'RAVi',
                                measured: data.input.RAVi ? parseFloat(data.input.RAVi).toFixed(2) : 'N/A',
                                zScore: data.results.calculated_sds ? parseFloat(data.results.calculated_sds).toFixed(2) : 'N/A',
                                centile: data.results.calculated_percentile ? parseFloat(data.results.calculated_percentile).toFixed(1) : 'N/A',
                                reference: data.reference_data ? 
                                    `P3: ${data.reference_data.P3_ml_per_m2} ml/m2; P50: ${data.reference_data.P50_ml_per_m2} ml/m2; P97: ${data.reference_data.P97_ml_per_m2} ml/m2` : 
                                    'N/A'
                            });
                        }
                    } catch (error) {
                        console.error('Error calculating RAVi:', error);
                    }
                }
                
                // Ventricular measurements
                const ventricularParams = [
                    { id: 'lvedv', param: 'LVEDV', indexed: 'LVEDVi' },
                    { id: 'lvesv', param: 'LVESV', indexed: 'LVESVi' },
                    { id: 'lvsv', param: 'LVSV', indexed: 'LVSVi' },
                    { id: 'lvm', param: 'LVM', indexed: 'LVMi' },
                    { id: 'rvedv', param: 'RVEDV', indexed: 'RVEDVi' },
                    { id: 'rvesv', param: 'RVESV', indexed: 'RVESVi' },
                    { id: 'rvsv', param: 'RVSV', indexed: 'RVSVi' },
                    { id: 'rvm', param: 'RVM', indexed: 'RVMi' }
                ];
                
                // Process ventricular measurements
                for (const { id, param, indexed } of ventricularParams) {
                    const value = parseFloat(document.getElementById(id).value);
                    if (!isNaN(value)) {
                        try {
                            const bsa = calculateBSA(ht_cm, wt_kg);
                            const indexedValue = value / bsa;  // Calculate indexed value

                            const response = await fetch(`${VENTRICULAR_API_URL}?domain=Pediatric_Ventricle&parameter=${param}&gender=${gender}&measured=${value}&ht_cm=${ht_cm}&wt_kg=${wt_kg}`);
                            const data = await response.json();
                            
                            if (data.results) {
                                // Add non-indexed result
                                results.push({
                                    parameter: param,
                                    measured: value.toFixed(2),
                                    zScore: data.results.calc_z ? parseFloat(data.results.calc_z).toFixed(2) : 'N/A',
                                    centile: data.results.calc_percentile ? parseFloat(data.results.calc_percentile).toFixed(1) : 'N/A',
                                    reference: data.results ? 
                                        `P3: ${parseFloat(data.results['3rd_percentile']).toFixed(2)} ml; P50: ${parseFloat(data.results['50th_percentile']).toFixed(2)} ml; P97: ${parseFloat(data.results['97th_percentile']).toFixed(2)} ml` : 
                                        'N/A'
                                });

                                // Add indexed result
                                const indexedResponse = await fetch(`${VENTRICULAR_API_URL}?domain=Pediatric_Ventricle&parameter=${indexed}&gender=${gender}&measured=${indexedValue}&ht_cm=${ht_cm}&wt_kg=${wt_kg}`);
                                const indexedData = await indexedResponse.json();

                                if (indexedData.results) {
                                    results.push({
                                        parameter: indexed,
                                        measured: indexedValue.toFixed(2),
                                        zScore: indexedData.results.calc_z ? parseFloat(indexedData.results.calc_z).toFixed(2) : 'N/A',
                                        centile: indexedData.results.calc_percentile ? parseFloat(indexedData.results.calc_percentile).toFixed(1) : 'N/A',
                                        reference: indexedData.results ? 
                                            `P3: ${parseFloat(indexedData.results['3rd_percentile']).toFixed(2)} ml/m²; P50: ${parseFloat(indexedData.results['50th_percentile']).toFixed(2)} ml/m²; P97: ${parseFloat(indexedData.results['97th_percentile']).toFixed(2)} ml/m²` : 
                                            'N/A'
                                    });
                                }
                            }
                        } catch (error) {
                            console.error(`Error calculating ${param}:`, error);
                        }
                    }
                }
                
                // Display results
                displayResults(results);
                
            } catch (error) {
                resultsContent.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            } finally {
                calculateBtn.disabled = false;
            }
        }

        // Modify displayResults function to store the current results
        let currentResults = [];
        
        function displayResults(results) {
            currentResults = results; // Store results for printing
            if (results.length === 0) {
                resultsContent.innerHTML = '<div class="error">No valid measurements entered</div>';
                return;
            }
            
            let tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Measured</th>
                            <th>Z-Score</th>
                            <th>Centile</th>
                            <th>Reference Percentiles</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(result => {
                tableHTML += `
                    <tr>
                        <td>${result.parameter}</td>
                        <td>${result.measured} ${result.parameter.includes('i') ? 'ml/m²' : 'ml'}</td>
                        <td>${result.zScore}</td>
                        <td>${result.centile}</td>
                        <td>${result.reference}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            resultsContent.innerHTML = tableHTML;
        }

        function printResults() {
            if (currentResults.length === 0) {
                alert('Please calculate results first');
                return;
            }

            const { ht_cm, wt_kg } = convertToMetric();
            const bsa = calculateBSA(ht_cm, wt_kg).toFixed(2);

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>CMR Results</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .print-header { margin-bottom: 20px; }
                        .print-header div { margin: 10px 0; }
                        .print-header input {
                            border: none;
                            border-bottom: 1px solid #000;
                            margin: 0 5px;
                            padding: 2px;
                        }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                        .footer { margin-top: 20px; font-size: 12px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <div>
                            Name: <input type="text" style="width: 200px">
                            ID: <input type="text" style="width: 100px">
                        </div>
                        <div>
                            Weight: ${wt_kg.toFixed(1)} kg
                            Height: ${ht_cm.toFixed(1)} cm
                            BSA: ${bsa} m²
                        </div>
                        <div>
                            Gender: ${document.getElementById('gender').value}
                        </div>
                    </div>
                    <h3>Results:</h3>
                    ${resultsContent.innerHTML}
                    <div class="footer">
                        Reference values fetched using <a href="https://miracleapi.readme.io/" target="_blank">MIRACLE API</a>. 
                        View the <a href="https://github.com/drankush/MIRACLE-API" target="_blank">GitHub repository</a>.
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }
    </script>
</body>
</html>